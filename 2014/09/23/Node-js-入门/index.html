

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="Abbey">
    
    <meta name="description" content="一个完整的基于Node.js的web应用
用例

用户通过浏览器使用我们的应用。
当用户请求http://domain/start时， 可以看到一个欢迎页面，页面上有一个文件上传的表单。
用户可以选择一个图片并提交表单，随后文件将被上传到http://domain/upload,该页面完成上传后会把">
    
    

    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Node.js 入门 | Abbey in Cradle Studio · 年少轻狂 | 立志成为一名游戏开发极客</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">


    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script> 
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.abbeychenxi.net" title="Abbey in Cradle Studio">Abbey in Cradle Studio</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                <p class="navbar-text pull-right">年少轻狂 | 立志成为一名游戏开发极客</p>

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/">首页</a></li>
                    
                    <li id="nav-archives"><a href="/archives">归档</a></li>
                    
                    <li id="nav-tags"><a href="/tags">标签</a></li>
                    
                    <li id="nav-categories"><a href="/categories">分类</a></li>
                    
                    <li id="nav-curriculumvitae"><a href="/about">关于</a></li>
                    
                    <li id="nav-links"><a href="/links">链接</a></li>
                    
                    
                    <li><a href="https://github.com/Abbeychenxi" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <script>
    var backRoot = "/images/background/";
    var backArray = [ "1.jpeg", "2.jpeg", "3.jpeg", "4.jpeg", "5.jpeg", "6.jpeg", "img/iPad_Photo_20140328181354FGPM.JPG", "img/iPad_Photo_20140328181218SLUY.JPG", "img/iPad_Photo_20140328181239ME9E.JPG", "img/iPad_Photo_20140328175718BF7T.JPG", "likeit/465_16170978_35afb62980c6d1a.jpg", "likeit/wallpaper-86487.jpg", "likeit/wallpaper-651939.jpg", "likeit/wallpaper-648634.jpg", "likeit/wallpaper-657798.jpg", "likeit/wallpaper-1479749.jpg", "likeit/wallpaper-1961179.jpg", "likeit/wallpaper-1947874.jpg", "likeit/wallpaper-2055407.jpg", "likeit/wallpaper-2060090.png", "likeit/wallpaper-2142870.jpg", "likeit/wallpaper-2078006.jpg", "likeit/wallpaper-2127699.jpg", "likeit/wallpaper-2211066.jpg", "likeit/wallpaper-2588686.jpg", "likeit/wallpaper-2639031.jpg", "likeit/wallpaper-2430341.jpg", "likeit/wallpaper-2294985.jpg", "likeit/wallpaper-2705897.jpg", "likeit/wallpaper-2063319.jpg", "likeit/wallpaper-2060101.jpg", "likeit/wallpaper-1970791.jpg", "img/iPad_Photo_20140328174508AZ11.JPG", "img/new/iPad_Photo_201403281903078UKK.JPG", "img/iPad_Photo_20140328175639RA5N.JPG", "img/iPad_Photo_20140328175820DYAC.JPG", "img/iPad_Photo_201403281806230195.JPG", "img/new/iPad_Photo_201403281919292STQ.JPG", "img/new/iPad_Photo_20140328190703781D.JPG", "flandre/p541758_2girls barefoot bat_wings bed blonde_hair blue_hair feet fetal_position flandre_scarlet flat_chest hat nude red_eyes ~.jpg", "flandre/p575023_blonde_hair flandre_scarlet hat horumon multiple_persona ponytail red_eyes side_ponytail touhou wings.jpg", "flandre/p569665_2girls barefoot blonde_hair blue_hair flandre_scarlet hat highres kinoko red_eyes remilia_scarlet siblings sisters to~.jpg", "flandre/p566082_blonde_hair flandre_scarlet hat mitsuki_(artist) ponytail red_eyes short_hair side_ponytail touhou wings.jpg", "flandre/p548132_2girls bat_wings blonde_hair blue_eyes blue_hair flandre_scarlet hat kaedena_akino mask moon red_eyes red_moon remili~.jpg", "flandre/p552906_flandre_scarlet gusutafu hong_meiling izayoi_sakuya koakuma patchouli_knowledge remilia_scarlet swimsuit touhou.jpg", "flandre/p551605_flandre_scarlet kona-ta touhou.jpg", "flandre/p551983_asuka_roze danmaku flandre_scarlet remilia_scarlet touhou.jpg", "likeit/465_16170978_2b89f5997bcff44.jpg", "likeit/wallpaper-616321.jpg", "likeit/wallpaper-343717.jpg", "likeit/wallpaper-1595016.jpg", "likeit/wallpaper-1952396.jpg", "likeit/wallpaper-2060096.jpg", "likeit/wallpaper-2315398.jpg", "likeit/wallpaper-2674370.jpg", "likeit/wallpaper-2838683.jpg", "likeit/wallpaper-2564028.png", "likeit/wallpaper-1382762.jpg", "likeit/wallpaper-1128042.jpg", "likeit/wallpaper-1396368.jpg", "likeit/wallpaper-1403569.png", "likeit/wallpaper-1593633.jpg", "likeit/wallpaper-1395408.jpg", "flandre/p539131_blonde_hair flandre_scarlet hat plastic_eraser red_eyes scenery short_hair solo touhou.jpg", "flandre/p555228_flandre_scarlet hong_meiling izayoi_sakuya patchouli_knowledge remilia_scarlet shomon swimsuit touhou.jpg", "flandre/p556145_book flandre_scarlet flower hairband hakurei_reimu hat hitoto hong_meiling izayoi_sakuya kirisame_marisa koakuma patc~.jpg", "flandre/p561220_arikichi_gen blonde_hair blue_eyes blue_hair braid flandre_scarlet izayoi_sakuya ponytail red_eyes remilia_scarlet sh~.jpg", "flandre/p541363_blonde_hair flandre_scarlet hat laevatein magic_circle poncho_(pixiv) red_eyes side_ponytail touhou wings.jpg",  ];
    //console.log(backArray);
        
    $(function() {
        // page-id...
        var pageId = "2014/09/23/Node-js-入门/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
    });
    </script>
    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>Node.js 入门</h1>
        
        <div class="time-info">
发表于:<time datetime="2014-09-23T11:43:54.000Z" itemprop="datePublished">2014-09-23</time>,
更新于:<time datetime="2014-10-25T18:30:14.000Z" itemprop="dateModified">2014-10-26</time>,
By <a href="http://www.abbeychenxi.net" title="Abbey">Abbey</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一个完整的基于Node-js的web应用"><span class="toc-number">1.</span> <span class="toc-text">一个完整的基于Node.js的web应用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#用例"><span class="toc-number"></span> <span class="toc-text">用例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应用不同模块分析"><span class="toc-number"></span> <span class="toc-text">应用不同模块分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#一个基础的HTTP服务器"><span class="toc-number"></span> <span class="toc-text">一个基础的HTTP服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析HTTP服务器"><span class="toc-number"></span> <span class="toc-text">分析HTTP服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#函数传递"><span class="toc-number"></span> <span class="toc-text">函数传递</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#函数传递是如何让HTTP服务器工作的"><span class="toc-number"></span> <span class="toc-text">函数传递是如何让HTTP服务器工作的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基于事件的驱动回调"><span class="toc-number"></span> <span class="toc-text">基于事件的驱动回调</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务器是如何处理请求的"><span class="toc-number"></span> <span class="toc-text">服务器是如何处理请求的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何来进行请求的“路由”"><span class="toc-number"></span> <span class="toc-text">如何来进行请求的“路由”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#行为驱动执行"><span class="toc-number"></span> <span class="toc-text">行为驱动执行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#路由给真正的请求处理程序"><span class="toc-number"></span> <span class="toc-text">路由给真正的请求处理程序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#阻塞与非阻塞"><span class="toc-number"></span> <span class="toc-text">阻塞与非阻塞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#以非阻塞操作进行请求响应"><span class="toc-number">1.</span> <span class="toc-text">以非阻塞操作进行请求响应</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#更有用的场景"><span class="toc-number"></span> <span class="toc-text">更有用的场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#处理POST请求"><span class="toc-number"></span> <span class="toc-text">处理POST请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#处理文件上传"><span class="toc-number">1.</span> <span class="toc-text">处理文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结与展望"><span class="toc-number">2.</span> <span class="toc-text">总结与展望</span></a></li></ol>
            </div>
            
            <h2 id="一个完整的基于Node-js的web应用">一个完整的基于Node.js的web应用</h2>
<h1 id="用例">用例</h1>
<ul>
<li>用户通过浏览器使用我们的应用。</li>
<li>当用户请求<a href="http://domain/start时，" target="_blank" rel="external">http://domain/start时，</a> 可以看到一个欢迎页面，页面上有一个文件上传的表单。</li>
<li>用户可以选择一个图片并提交表单，随后文件将被上传到<a href="http://domain/upload,该页面完成上传后会把图片显示在页面上。" target="_blank" rel="external">http://domain/upload,该页面完成上传后会把图片显示在页面上。</a></li>
</ul>
<h1 id="应用不同模块分析">应用不同模块分析</h1>
<ul>
<li>需要提供Web页面，因此需要一个HTTP服务器</li>
<li>对于不同的请求，根据请求的URL，我们服务器给予不同的响应，因此需要一个路由，用于把请求对应到请求处理程序</li>
<li>当请求被服务器接收并通过路由传递之后，需要可以对其进行处理，需要最终的请求处理程序</li>
<li>路由还应该能处理POST数据，并且把数据封装成更友好的格式传递给请求处理程序，因此需要请求数据处理功能</li>
<li>我们不仅仅要处理URL对应的请求，还要把内容显示出来，这意味着我们需要一些视图逻辑供请求处理程序使用，以便将内容发送给用户的浏览器</li>
<li>最后，用户需要上传图片，所以需要上传处理功能</li>
</ul>
<h1 id="一个基础的HTTP服务器">一个基础的HTTP服务器</h1>
<p>服务器模块：创建一个server.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var http = require(<span class="string">"http"</span>);</div><div class="line">http.createServer(<span class="keyword">function</span>(<span class="built_in">request</span>, <span class="built_in">response</span>) {</div><div class="line">	<span class="built_in">response</span>.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">	<span class="built_in">response</span>.write(<span class="string">"Hello World"</span>);</div><div class="line">	<span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">}).listen(<span class="number">8888</span>);</div></pre></td></tr></table></figure>

<h1 id="分析HTTP服务器">分析HTTP服务器</h1>
<p>引入一个http模块并复制给http变量，接下来调用createServer函数。<br>这个函数返回一个对象，并调用listen方法，指定http服务器监听的端口号。</p>
<h1 id="函数传递">函数传递</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">(someFunction, value)</span> </span>{</div><div class="line">	someFunction(value);</div><div class="line">}</div><div class="line"></div><div class="line">excute(<span class="function"><span class="keyword">function</span><span class="params">(word)</span> </span>{<span class="built_in">console</span>.log (word) }, <span class="string">"hello"</span>);</div></pre></td></tr></table></figure>

<h1 id="函数传递是如何让HTTP服务器工作的">函数传递是如何让HTTP服务器工作的</h1>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var http = require(<span class="string">"http"</span>);</div><div class="line"></div><div class="line"><span class="keyword">function</span> onRequest(<span class="built_in">request</span>, <span class="built_in">response</span>) {</div><div class="line">	<span class="built_in">response</span>.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">	<span class="built_in">response</span>.write(<span class="string">"hello world"</span>);</div><div class="line">	<span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">}</div><div class="line"></div><div class="line">http.createServer(onRequest).listen(<span class="number">8888</span>);</div></pre></td></tr></table></figure>

<h1 id="基于事件的驱动回调">基于事件的驱动回调</h1>
<p><a href="http://debuggable.com/posts/understanding-node-js:4bd98440-45e4-4a9a-8ef7-0f7ecbdd56cb" target="_blank" rel="external">Understanding node.js</a>介绍了一些背景知识。</p>
<p>服务器收到HTTP请求的时候是异步的，请求任何时候都可能到达，但是我们服务器却跑在一个单进程中。</p>
<h1 id="服务器是如何处理请求的">服务器是如何处理请求的</h1>
<p>收到请求的时候，使用reponse.writeHead()函数发送一个HTTP状态200和HTTP头的内容类型，使用response.write()函数在HTTP相应主体中发送文本“Hello World”。<br>最后，调用response.end()完成响应。</p>
<p>把服务器脚本放到一个start函数里，然后导出这个函数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> </span>{</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"Request received."</span>);</div><div class="line">		response.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">		response.write(<span class="string">"Hello World"</span>);</div><div class="line">		response.end();</div><div class="line">	}</div><div class="line">	http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"Server has started."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>在index.js文件中写入：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> server = <span class="built_in">require</span>(<span class="string">"./server"</span>);</div><div class="line"></div><div class="line">server.start();</div></pre></td></tr></table></figure>

<h1 id="如何来进行请求的“路由”">如何来进行请求的“路由”</h1>
<p>数据都会包含在request对象中，该对象作为onRequest()回调函数的第一个参数传递。为了解析这些数据，需要额外的Node.js模块，分别是url和querystring模块。</p>
<pre><code>                           url.parse(string).query
                                       <span class="string">|</span>
       url.parse(string).pathname      <span class="string">|</span>
                   <span class="string">|                   |</span>
                   <span class="string">|                   |</span>
                 ------ -------------------
http:<span class="comment">//localhost:8888/start?foo=bar&amp;hello=world</span>
                            ---       -----
                             <span class="string">|          |</span>
                             <span class="string">|          |</span>
          querystring(string)[<span class="string">"foo"</span>]    <span class="string">|</span>
                                        <span class="string">|</span>
                     querystring(string)[<span class="string">"hello"</span>]
</code></pre><p>现在给onRequest()函数加上逻辑，用来找出浏览器请求的URL路径:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> </span>{</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">		<span class="keyword">var</span> pathname = url.parse(request.url).pathname;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</div><div class="line">		response.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">		response.write(<span class="string">"Hello World"</span>);</div><div class="line">		response.end();</div><div class="line">	}</div><div class="line">	http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>编写路由：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">route</span><span class="params">(pathname)</span> </span>{</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"About to route a request for "</span> + pathname);</div><div class="line">}</div><div class="line"></div><div class="line">exports.route = route;</div></pre></td></tr></table></figure>

<p>服务器应当知道路由的存在并且加以利用。可以使用依赖注入的方式较松散地添加路由模块。<a href="http://martinfowler.com/articles/injection.html" target="_blank" rel="external">Martin Fowlers 关于依赖注入</a>的文章来作为背景知识。</p>
<p>扩展start()函数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(route)</span> </span>{</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">    <span class="keyword">var</span> pathname = url.parse(request.url).pathname;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</div><div class="line"></div><div class="line">    route(pathname);</div><div class="line"></div><div class="line">    response.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">    response.write(<span class="string">"Hello World"</span>);</div><div class="line">    response.end();</div><div class="line">  }</div><div class="line"></div><div class="line">  http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"Server has started."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>相应的扩展index.js，使得路由函数可以被注入到服务器中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> server = <span class="built_in">require</span>(<span class="string">"./server"</span>);</div><div class="line"><span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">"./router"</span>);</div><div class="line"></div><div class="line">server.start(router.route);</div></pre></td></tr></table></figure>

<h1 id="行为驱动执行">行为驱动执行</h1>
<p>Steve Yegge<a href="http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html" target="_blank" rel="external">名词王国中的死刑</a>帮助理解函数编程</p>
<h1 id="路由给真正的请求处理程序">路由给真正的请求处理程序</h1>
<p>创建一个requestHandlers的模块：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> </span>{</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"Request handler 'start' was called."</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span> </span>{</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"Request handler 'upload' was called."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div><div class="line">exports.upload = upload;</div></pre></td></tr></table></figure>

<p>在javascript中，对象就是一个键/值对的集合—你可以把javascript的对象想象成一个键为字符串类型的字典。</p>
<p>将对象引入到index.js：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> server <span class="subst">=</span> <span class="keyword">require</span>(<span class="string">"./server"</span>);</div><div class="line"><span class="built_in">var</span> router <span class="subst">=</span> <span class="keyword">require</span>(<span class="string">"./router"</span>);</div><div class="line"><span class="built_in">var</span> requestHandlers <span class="subst">=</span> <span class="keyword">require</span>(<span class="string">"./requestHandlers"</span>);</div><div class="line"></div><div class="line"><span class="built_in">var</span> <span class="keyword">handle</span> <span class="subst">=</span> {};</div><div class="line"><span class="keyword">handle</span><span class="preprocessor">[</span><span class="string">"/"</span><span class="preprocessor">]</span><span class="markup"> = requestHandlers.start;</span></div><div class="line">handle<span class="preprocessor">[</span><span class="string">"/start"</span><span class="preprocessor">]</span><span class="markup"> = requestHandlers.start;</span></div><div class="line">handle<span class="preprocessor">[</span><span class="string">"/upload"</span><span class="preprocessor">]</span><span class="markup"> = requestHandlers.upload;</span></div><div class="line"></div><div class="line">server.start(router.route, handle);</div></pre></td></tr></table></figure>

<p>完成了对象的定义之后，把它作为额外的参数传递给服务器，将server.js修改如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(route, handle)</span> </span>{</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">    <span class="keyword">var</span> pathname = url.parse(request.url).pathname;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</div><div class="line"></div><div class="line">    route(handle, pathname);</div><div class="line"></div><div class="line">    response.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">    response.write(<span class="string">"Hello World"</span>);</div><div class="line">    response.end();</div><div class="line">  }</div><div class="line"></div><div class="line">  http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"Server has started."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>这样我们就在start()函数里添加了handle参数，并且把handle对象作为第一个参数传递给了route()回调函数。<br>修改route.js文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">route</span><span class="params">(handle, pathname)</span> </span>{</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"About to route a request for "</span> + pathname);</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handle[pathname] === <span class="string">'function'</span>) {</div><div class="line">    handle[pathname]();</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"No request handler found for "</span> + pathname);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line">exports.route = route;</div></pre></td></tr></table></figure>

<h1 id="阻塞与非阻塞">阻塞与非阻塞</h1>
<p><a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/" target="_blank" rel="external">理解node.js的事件轮询</a></p>
<p>简单又实用的非阻塞操作exec()</p>
<h2 id="以非阻塞操作进行请求响应">以非阻塞操作进行请求响应</h2>
<p>Node.js的实现方案:函数传递。<br>将内容传递给服务器的方式，将服务器“传递”给内容的方式。<br>就是将response对象通过请求路由传递给请求处理程序。随后，处理程序就可以采用该对象上的函数来对请求作出响应。<br>从server.js开始：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(route, handle)</span> </span>{</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">    <span class="keyword">var</span> pathname = url.parse(request.url).pathname;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</div><div class="line"></div><div class="line">    route(handle, pathname, response);</div><div class="line">  }</div><div class="line"></div><div class="line">  http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"Server has started."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>将response对象作为第三个参数传递给route()函数，并且，将onRequest()处理程序中所有有关response的函数调用都移除，因为这部分工作让route()函数完成。</p>
<p>router.js：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> route(handle, pathname, <span class="built_in">response</span>) {</div><div class="line">	console.<span class="built_in">log</span>(<span class="string">"About to route a request for "</span> + pathname);</div><div class="line">	<span class="keyword">if</span>(typeof handle[pathname] === <span class="comment">'function') {</span></div><div class="line">		handle[pathname](<span class="built_in">response</span>);</div><div class="line">	}<span class="keyword">else</span> {</div><div class="line">		console.<span class="built_in">log</span>(<span class="string">"No request handler found for "</span> + pathname);</div><div class="line">    <span class="built_in">response</span>.writeHead(<span class="number">404</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">    <span class="built_in">response</span>.write(<span class="string">"404 Not found"</span>);</div><div class="line">    <span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line">exports.route = route;</div></pre></td></tr></table></figure>

<p>将requestHandler.js修改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">var exec = require(<span class="string">"child_process"</span>).exec;</div><div class="line"></div><div class="line"><span class="keyword">function</span> start(<span class="built_in">response</span>) {</div><div class="line">  console.<span class="built_in">log</span>(<span class="string">"Request handler 'start' was called."</span>);</div><div class="line"></div><div class="line">  exec(<span class="string">"ls -lah"</span>, <span class="keyword">function</span> (<span class="keyword">error</span>, stdout, stderr) {</div><div class="line">    <span class="built_in">response</span>.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">    <span class="built_in">response</span>.write(stdout);</div><div class="line">    <span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">  });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">function</span> upload(<span class="built_in">response</span>) {</div><div class="line">  console.<span class="built_in">log</span>(<span class="string">"Request handler 'upload' was called."</span>);</div><div class="line">  <span class="built_in">response</span>.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">  <span class="built_in">response</span>.write(<span class="string">"Hello Upload"</span>);</div><div class="line">  <span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div><div class="line">exports.upload = upload;</div></pre></td></tr></table></figure>

<h1 id="更有用的场景">更有用的场景</h1>
<ul>
<li>尽管Node.js中处理基础的POST请求相对比较简单，但在这过程中还是能学到很多</li>
<li>用Node.js来处理文件上传比较复杂</li>
</ul>
<h1 id="处理POST请求">处理POST请求</h1>
<p>将requestHandlers.js修改为如下形式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(response)</span> {</span></div><div class="line">  <span class="transposed_variable">console.</span>log(<span class="string">"Request handler '</span><span class="transposed_variable">start'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line"></div><div class="line">  var body = '&lt;html&gt;<span class="string">'+</span></div><div class="line">    '&lt;head&gt;<span class="string">'+</span></div><div class="line">    '&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; '</span>+</div><div class="line">    <span class="string">'charset=UTF-8"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/head&gt;<span class="string">'+</span></div><div class="line">    '&lt;body&gt;<span class="string">'+</span></div><div class="line">    '&lt;form action=<span class="string">"/upload"</span> method=<span class="string">"post"</span>&gt;<span class="string">'+</span></div><div class="line">    '&lt;textarea name=<span class="string">"text"</span> rows=<span class="string">"20"</span> cols=<span class="string">"60"</span>&gt;&lt;/textarea&gt;<span class="string">'+</span></div><div class="line">    '&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit text"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/form&gt;<span class="string">'+</span></div><div class="line">    '&lt;/body&gt;<span class="string">'+</span></div><div class="line">    '&lt;/html&gt;<span class="string">';</span></div><div class="line"></div><div class="line">    response.writeHead(200, {"Content-Type<span class="string">": "</span>text/html<span class="string">"});</span></div><div class="line">    response.write(body);</div><div class="line">    response.end();</div><div class="line">}</div><div class="line"></div><div class="line">function upload(response) {</div><div class="line">  console.log("Request handler <span class="string">'upload'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line">  response.writeHead(200, {"Content-Type<span class="string">": "</span>text/plain<span class="string">"});</span></div><div class="line">  response.write("Hello Upload<span class="string">");</span></div><div class="line">  response.end();</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div><div class="line">exports.upload = upload;</div></pre></td></tr></table></figure>

<p>为了使得整个过程非阻塞，Node.js会将POST数据拆分成很多小块，然后通过触发特定的事件，将这些小数据库传递给回调函数。</p>
<p>我们需要告诉Node.js当这些事件触发的时候，回调哪些函数。通过在request对象上注册监听器来实现。这里的request对象是每次接收到HTTP请求时候，都会把该对象传递给onRequest回调函数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">request.addListener(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span><span class="params">(chunk)</span> </span>{</div><div class="line">  <span class="comment">// called when a new chunk of data was received</span></div><div class="line">});</div><div class="line"></div><div class="line">request.addListener(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">  <span class="comment">// called when all chunks of data have been received</span></div><div class="line">});</div></pre></td></tr></table></figure>

<p>从server.js开始：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(route, handle)</span> </span>{</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(request, response)</span> </span>{</div><div class="line">    <span class="keyword">var</span> postData = <span class="string">""</span>;</div><div class="line">    <span class="keyword">var</span> pathname = url.parse(request.url).pathname;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Request for "</span> + pathname + <span class="string">" received."</span>);</div><div class="line"></div><div class="line">    request.setEncoding(<span class="string">"utf8"</span>);</div><div class="line"></div><div class="line">    request.addListener(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span><span class="params">(postDataChunk)</span> </span>{</div><div class="line">      postData += postDataChunk;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"Received POST data chunk '"</span>+</div><div class="line">      postDataChunk + <span class="string">"'."</span>);</div><div class="line">    });</div><div class="line"></div><div class="line">    request.addListener(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">      route(handle, pathname, response, postData);</div><div class="line">    });</div><div class="line"></div><div class="line">  }</div><div class="line"></div><div class="line">  http.createServer(onRequest).listen(<span class="number">8888</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"Server has started."</span>);</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div></pre></td></tr></table></figure>

<p>上述代码做了三件事情：</p>
<ul>
<li>设置了接收数据的编码格式为UTF-8</li>
<li>注册了“data”事件的监听器，用于收集每次接收到的新数据块，并赋值给postData变量</li>
<li>将请求路由的调用移到end事件处理程序中，以确保它只会当所有数据接收完毕后才触发，并且只触发一次。同时把POST数据传递给请求路由，因为数据，请求处理程序会用到</li>
</ul>
<p>在upload页面，展示用户输入的内容。修改router.js：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> route(handle, pathname, <span class="built_in">response</span>, postData) {</div><div class="line">  console.<span class="built_in">log</span>(<span class="string">"About to route a request for "</span> + pathname);</div><div class="line">  <span class="keyword">if</span> (typeof handle[pathname] === <span class="comment">'function') {</span></div><div class="line">    handle[pathname](<span class="built_in">response</span>, postData);</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    console.<span class="built_in">log</span>(<span class="string">"No request handler found for "</span> + pathname);</div><div class="line">    <span class="built_in">response</span>.writeHead(<span class="number">404</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">    <span class="built_in">response</span>.write(<span class="string">"404 Not found"</span>);</div><div class="line">    <span class="built_in">response</span>.<span class="keyword">end</span>();</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line">exports.route = route;</div></pre></td></tr></table></figure>

<p>然后，在requestHandler.js中，将数据包含在对upload请求的响应中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(response, postData)</span> {</span></div><div class="line">  <span class="transposed_variable">console.</span>log(<span class="string">"Request handler '</span><span class="transposed_variable">start'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line"></div><div class="line">  var body = '&lt;html&gt;<span class="string">'+</span></div><div class="line">    '&lt;head&gt;<span class="string">'+</span></div><div class="line">    '&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; '</span>+</div><div class="line">    <span class="string">'charset=UTF-8"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/head&gt;<span class="string">'+</span></div><div class="line">    '&lt;body&gt;<span class="string">'+</span></div><div class="line">    '&lt;form action=<span class="string">"/upload"</span> method=<span class="string">"post"</span>&gt;<span class="string">'+</span></div><div class="line">    '&lt;textarea name=<span class="string">"text"</span> rows=<span class="string">"20"</span> cols=<span class="string">"60"</span>&gt;&lt;/textarea&gt;<span class="string">'+</span></div><div class="line">    '&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit text"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/form&gt;<span class="string">'+</span></div><div class="line">    '&lt;/body&gt;<span class="string">'+</span></div><div class="line">    '&lt;/html&gt;<span class="string">';</span></div><div class="line"></div><div class="line">    response.writeHead(200, {"Content-Type<span class="string">": "</span>text/html<span class="string">"});</span></div><div class="line">    response.write(body);</div><div class="line">    response.end();</div><div class="line">}</div><div class="line"></div><div class="line">function upload(response, postData) {</div><div class="line">  console.log("Request handler <span class="string">'upload'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line">  response.writeHead(200, {"Content-Type<span class="string">": "</span>text/plain<span class="string">"});</span></div><div class="line">  response.write("<span class="transposed_variable">You'</span>ve sent: <span class="string">" + postData);</span></div><div class="line">  response.end();</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div><div class="line">exports.upload = upload;</div></pre></td></tr></table></figure>

<p>最后做的是：我们是把请求的整个消息传递给了请求路由和请求处理程序。我们应该只把POST数据中，感兴趣的部分传递给请求路由和请求处理程序。</p>
<p>querystring模块：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">var querystring = require(<span class="string">"querystring"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">(response, postData)</span> {</span></div><div class="line">  <span class="transposed_variable">console.</span>log(<span class="string">"Request handler '</span><span class="transposed_variable">start'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line"></div><div class="line">  var body = '&lt;html&gt;<span class="string">'+</span></div><div class="line">    '&lt;head&gt;<span class="string">'+</span></div><div class="line">    '&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; '</span>+</div><div class="line">    <span class="string">'charset=UTF-8"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/head&gt;<span class="string">'+</span></div><div class="line">    '&lt;body&gt;<span class="string">'+</span></div><div class="line">    '&lt;form action=<span class="string">"/upload"</span> method=<span class="string">"post"</span>&gt;<span class="string">'+</span></div><div class="line">    '&lt;textarea name=<span class="string">"text"</span> rows=<span class="string">"20"</span> cols=<span class="string">"60"</span>&gt;&lt;/textarea&gt;<span class="string">'+</span></div><div class="line">    '&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit text"</span> /&gt;<span class="string">'+</span></div><div class="line">    '&lt;/form&gt;<span class="string">'+</span></div><div class="line">    '&lt;/body&gt;<span class="string">'+</span></div><div class="line">    '&lt;/html&gt;<span class="string">';</span></div><div class="line"></div><div class="line">    response.writeHead(200, {"Content-Type<span class="string">": "</span>text/html<span class="string">"});</span></div><div class="line">    response.write(body);</div><div class="line">    response.end();</div><div class="line">}</div><div class="line"></div><div class="line">function upload(response, postData) {</div><div class="line">  console.log("Request handler <span class="string">'upload'</span> was <span class="transposed_variable">called.</span><span class="string">");</span></div><div class="line">  response.writeHead(200, {"Content-Type<span class="string">": "</span>text/plain<span class="string">"});</span></div><div class="line">  response.write("<span class="transposed_variable">You'</span>ve sent the text: <span class="string">"+</span></div><div class="line">  querystring.parse(postData).text);</div><div class="line">  response.end();</div><div class="line">}</div><div class="line"></div><div class="line">exports.start = start;</div><div class="line">exports.upload = upload;</div></pre></td></tr></table></figure>

<h2 id="处理文件上传">处理文件上传</h2>
<p>外部模块：Felix Geisendorfer开发的node-formidable模块。</p>
<ul>
<li>在/start表单中添加一个文件上传元素</li>
<li>将node-formidable整合到我们的upload请求处理程序中，用于将上传的图片保存到./test.png</li>
<li>将上传的图片内嵌到/uploadURL输出的HTML中</li>
</ul>
<p>将request对象从服务器开始一路通过请求路由，在传递给请求处理程序。</p>
<p>我们可以将postData从服务器以及请求处理程序中移除—对于我们处理文件上传来说不需要了，另一方面，Node.js不会对数据做缓存</p>
<p>采用fs.renameSync(path1, path2)实现将文件保存到本地目录下</p>
<h2 id="总结与展望">总结与展望</h2>
<p>本书没有涉及到的：如何操作数据库，如何进行单元测试、如何开发Node.js的外部模块以及一些简单的诸如如何获取GET请求之类的方法。</p>

            
            <section class="comment">
	<div class="ds-thread" data-thread-key="2014/09/23/Node-js-入门/" data-title="Node.js 入门" data-url=""></div>
</section>

<script type="text/javascript">
  var duoshuoQuery = {short_name:"abbeychenxi"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>

        </div>
    </div>
</article>

    <footer id="footer">
    <div id="bottom-tip">
        Abbey in Cradle Studio —— <small>年少轻狂 | 立志成为一名游戏开发极客</small>
    </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载Cradle Studio主题</small><br />
        <small>&copy; 2014 Abbey</small>
    </footer>
</body>
</html>

